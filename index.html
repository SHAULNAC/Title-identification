<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מעמד הכותרות החכם</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.1/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        body { font-family: system-ui, sans-serif; margin: 40px; background: #f4f7f6; line-height: 1.6; }
        .container { max-width: 600px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: auto; }
        h1 { color: #2c3e50; text-align: center; }
        .setting { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #219150; }
        #status { margin-top: 20px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>מעמד כותרות אוטומטי</h1>
    
    <div class="setting">
        <label>מילת מפתח לכותרת (למשל: סימן):</label>
        <input type="text" id="keyword" value="סימן">
    </div>

    <div class="setting">
        <label>מספר מילים מקסימלי לכותרת:</label>
        <input type="number" id="maxWords" value="6">
    </div>

    <div class="setting">
        <label>בחר קובץ Word (.docx):</label>
        <input type="file" id="fileInput" accept=".docx">
    </div>

    <button onclick="processDocx()">עבד והורד קובץ מתוקן</button>
    <div id="status"></div>
</div>

<script>
    async function processDocx() {
        const fileInput = document.getElementById('fileInput');
        const keyword = document.getElementById('keyword').value;
        const maxWords = parseInt(document.getElementById('maxWords').value);
        const status = document.getElementById('status');

        if (!fileInput.files[0]) {
            alert("אנא בחר קובץ");
            return;
        }

        status.innerText = "מעבד...";

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const content = e.target.result;
                const zip = new PizZip(content);
                const xmlString = zip.file("word/document.xml").asText();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "application/xml");
                const paragraphs = Array.from(xmlDoc.getElementsByTagName("w:p"));

                for (let i = 0; i < paragraphs.length; i++) {
                    const p = paragraphs[i];
                    const text = p.textContent.trim();
                    const words = text.split(/\s+/);

                    let styleToApply = null;

                    // לוגיקה: זיהוי רצף של מילת מפתח
                    if (text.startsWith(keyword)) {
                        const nextP = paragraphs[i + 1];
                        const nextText = nextP ? nextP.textContent.trim() : "";

                        if (nextText.startsWith(keyword)) {
                            styleToApply = "Heading1";
                            // נסמן גם את הבא בתור כ-Heading2 בלולאה הבאה
                            paragraphs[i+1]._forceHeading2 = true; 
                        } else if (p._forceHeading2) {
                            styleToApply = "Heading2";
                        } else {
                            styleToApply = "Heading2";
                        }
                    } 
                    // לוגיקה: מספר מילים
                    else if (text.length > 0 && words.length <= maxWords) {
                        styleToApply = "Heading3";
                    }

                    if (styleToApply) {
                        applyStyleToParagraph(xmlDoc, p, styleToApply);
                    }
                }

                // שמירה
                const serializer = new XMLSerializer();
                const newXmlString = serializer.serializeToString(xmlDoc);
                zip.file("word/document.xml", newXmlString);
                
                const out = zip.generate({type:"blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
                saveAs(out, "processed_" + fileInput.files[0].name);
                status.innerText = "הסתיים בהצלחה!";

            } catch (err) {
                console.error(err);
                status.innerText = "שגיאה בעיבוד הקובץ";
            }
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }

    function applyStyleToParagraph(xmlDoc, p, styleName) {
        let pPr = p.getElementsByTagName("w:pPr")[0];
        if (!pPr) {
            pPr = xmlDoc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:pPr");
            p.insertBefore(pPr, p.firstChild);
        }
        
        let pStyle = pPr.getElementsByTagName("w:pStyle")[0];
        if (!pStyle) {
            pStyle = xmlDoc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:pStyle");
            pPr.insertBefore(pStyle, pPr.firstChild);
        }
        pStyle.setAttribute("w:val", styleName);
    }
</script>

</body>
</html>
