<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מעמד ספרים מקצועי - גרסה יציבה</title>
    <script src="pizzip.min.js"></script>
    <script src="FileSaver.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #eef2f3; }
        .sidebar { width: 350px; background: #2c3e50; color: white; padding: 20px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
        .rule-group { background: #34495e; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #456789; }
        .main-content { flex: 1; padding: 40px; overflow-y: auto; background: #dcdde1; display: flex; flex-direction: column; align-items: center; }
        .preview-page { width: 100%; max-width: 800px; background: white; padding: 60px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); min-height: 100vh; }
        
        /* עיצוב כותרות בתצוגה */
        .h1-preview { font-size: 1.8em; font-weight: bold; color: #2980b9; border-right: 5px solid #2980b9; padding-right: 15px; background: #f0f7ff; margin: 20px 0; }
        .h2-preview { font-size: 1.4em; font-weight: bold; color: #c0392b; border-right: 3px solid #c0392b; padding-right: 12px; background: #fff5f5; margin: 15px 0; }
        .centered-preview { text-align: center; display: block; }
        
        #status-box { padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; font-weight: bold; }
        .status-waiting { background: #f1c40f; color: #000; }
        .status-ready { background: #2ecc71; color: #fff; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; background: #1abc9c; color: white; margin-top: 10px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>הגדרות עימוד</h2>
    <div id="status-box" class="status-waiting">בודק ספריות...</div>
    
    <input type="file" id="fileInput" accept=".docx" style="margin-bottom: 20px;">
    
    <div id="controls" style="display:none;">
        <div class="rule-group">
            <h3>כותרת 1</h3>
            <label><input type="checkbox" id="h1_key_check" checked> מתחיל ב:</label>
            <input type="text" id="h1_key_val" value="סימן">
        </div>
        <div class="rule-group">
            <h3>כותרת 2</h3>
            <label><input type="checkbox" id="h2_key_check" checked> מתחיל ב:</label>
            <input type="text" id="h2_key_val" value="סעיף">
            <label><input type="checkbox" id="h2_center_check"> אם הפסקה ממורכזת</label>
        </div>
        <button class="btn" onclick="updatePreview()">רענן תצוגה</button>
        <button class="btn" style="background:#e67e22" onclick="downloadModifiedDocx()">הורד קובץ מתוקן</button>
    </div>
</div>

<div class="main-content">
    <div class="preview-page" id="previewArea"></div>
</div>

<script>
    let originalZip = null;
    let paragraphsData = [];

    // בדיקת טעינה
    const checkInterval = setInterval(() => {
        if (typeof PizZip !== 'undefined') {
            const sb = document.getElementById('status-box');
            sb.innerText = "מוכן לעבודה!";
            sb.className = "status-ready";
            clearInterval(checkInterval);
        }
    }, 500);

    document.getElementById('fileInput').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            originalZip = new PizZip(ev.target.result);
            parseDoc();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function parseDoc() {
        const xml = originalZip.file("word/document.xml").asText();
        const doc = new DOMParser().parseFromString(xml, "application/xml");
        const ps = Array.from(doc.getElementsByTagNameNS("*", "p"));

        paragraphsData = ps.map(p => {
            const text = Array.from(p.getElementsByTagNameNS("*", "t")).map(t => t.textContent).join("");
            const isCentered = p.getElementsByTagNameNS("*", "jc")[0]?.getAttribute("w:val") === "center";
            return { text: text.trim(), isCentered, originalElement: p };
        }).filter(p => p.text.length > 0);

        document.getElementById('controls').style.display = 'block';
        updatePreview();
    }

    function updatePreview() {
        const area = document.getElementById('previewArea');
        area.innerHTML = '';
        const h1_val = document.getElementById('h1_key_val').value;
        const h2_val = document.getElementById('h2_key_val').value;
        const h2_center = document.getElementById('h2_center_check').checked;

        paragraphsData.forEach(p => {
            let role = null;
            if (p.text.startsWith(h1_val)) role = 'h1';
            else if (p.text.startsWith(h2_val) || (h2_center && p.isCentered)) role = 'h2';

            p.currentRole = role;
            const d = document.createElement('div');
            d.innerText = p.text;
            if (role === 'h1') d.className = 'h1-preview';
            else if (role === 'h2') d.className = 'h2-preview';
            if (p.isCentered) d.classList.add('centered-preview');
            area.appendChild(d);
        });
    }

    function downloadModifiedDocx() {
        const xml = originalZip.file("word/document.xml").asText();
        const doc = new DOMParser().parseFromString(xml, "application/xml");
        const ps = Array.from(doc.getElementsByTagNameNS("*", "p"));

        let idx = 0;
        ps.forEach(p => {
            if (p.textContent.trim().length > 0 && paragraphsData[idx]) {
                const role = paragraphsData[idx].currentRole;
                if (role) {
                    let pPr = p.getElementsByTagNameNS("*", "pPr")[0] || doc.createElementNS("*", "w:pPr");
                    if (!p.contains(pPr)) p.insertBefore(pPr, p.firstChild);
                    let style = pPr.getElementsByTagNameNS("*", "pStyle")[0] || doc.createElementNS("*", "w:pStyle");
                    if (!pPr.contains(style)) pPr.appendChild(style);
                    style.setAttribute("w:val", role === 'h1' ? "Heading1" : "Heading2");
                }
                idx++;
            }
        });
        originalZip.file("word/document.xml", new XMLSerializer().serializeToString(doc));
        saveAs(originalZip.generate({type:"blob"}), "מעומד.docx");
    }
</script>
</body>
</html>
