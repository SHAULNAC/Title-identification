<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מעמד ספרים מקצועי - גרסת הלוגיקה המלאה</title>
    <script src="pizzip.min.js"></script>
    <script src="FileSaver.min.js"></script>
    
    <style>
        :root { --sidebar-width: 380px; --primary: #1abc9c; --accent: #e67e22; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #dcdde1; overflow: hidden; }
        
        /* תפריט צד */
        .sidebar { width: var(--sidebar-width); background: #2c3e50; color: white; padding: 20px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.3); }
        .sidebar h2 { border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 1.2rem; margin-top: 0; }
        
        /* מערכות חוקים */
        .rule-system { background: #34495e; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-right: 5px solid var(--primary); }
        .rule-system.h2-system { border-right-color: #c0392b; }
        .rule-system h3 { margin: 0 0 10px 0; font-size: 1rem; color: #ecf0f1; }
        
        .condition-row { display: grid; grid-template-columns: 25px 1fr 80px; align-items: center; gap: 5px; margin-bottom: 8px; font-size: 0.85rem; }
        .condition-row input[type="text"], .condition-row input[type="number"] { width: 100%; padding: 4px; border-radius: 3px; border: none; }
        
        /* אזור תצוגה מקדימה - תיקון הגלילה */
        .main-view { flex: 1; display: flex; justify-content: center; overflow-y: auto; padding: 40px 20px; scroll-behavior: smooth; }
        .paper-sheet { 
            width: 100%; max-width: 800px; background: white; min-height: 100%; 
            padding: 50px; box-shadow: 0 0 20px rgba(0,0,0,0.15); border-radius: 4px;
            box-sizing: border-box; position: relative;
        }

        /* עיצוב כותרות בתצוגה */
        .p-preview { margin: 8px 0; padding: 4px; border-radius: 3px; border: 1px solid transparent; }
        .h1-style { font-size: 1.8em; font-weight: bold; color: #2980b9; background: #ebf5fb; border: 1px dashed #2980b9; }
        .h2-style { font-size: 1.4em; font-weight: bold; color: #c0392b; background: #fdedec; border: 1px dashed #c0392b; }
        .center-text { text-align: center; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; margin-top: 10px; transition: 0.2s; }
        .btn-update { background: var(--primary); }
        .btn-download { background: var(--accent); }
        .status-ready { color: #2ecc71; font-weight: bold; margin-bottom: 10px; display: block; }
        small { font-size: 0.75rem; color: #bdc3c7; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>הגדרות עימוד</h2>
    <span id="lib-status" style="color: #f1c40f;">טוען ספריות...</span>
    
    <input type="file" id="fileInput" accept=".docx" style="margin: 15px 0;">

    <div id="ui-controls" style="display:none;">
        <div class="rule-system">
            <h3>מערכת כותרת 1 (H1)</h3>
            <div class="condition-row">
                <input type="checkbox" id="h1_double_check">
                <span>ראשון מ-2 שמתחילים ב:</span>
                <input type="text" id="h1_double_val" value="סימן">
            </div>
            <div class="condition-row">
                <input type="checkbox" id="h1_center_check"> <span>ממורכז</span> <small>לבד?</small>
                <input type="checkbox" id="h1_center_only">
            </div>
            <div class="condition-row">
                <input type="checkbox" id="h1_bold_check"> <span>מודגש (Bold)</span> <small>לבד?</small>
                <input type="checkbox" id="h1_bold_only">
            </div>
            <div class="condition-row">
                <input type="checkbox" id="h1_words_check"> <span>קצר מ-</span> 
                <input type="number" id="h1_words_val" value="5">
            </div>
        </div>

        <div class="rule-system h2-system">
            <h3>מערכת כותרת 2 (H2)</h3>
            <div class="condition-row">
                <input type="checkbox" id="h2_center_check"> <span>ממורכז</span> <small>לבד?</small>
                <input type="checkbox" id="h2_center_only">
            </div>
            <div class="condition-row">
                <input type="checkbox" id="h2_bold_check"> <span>מודגש (Bold)</span> <small>לבד?</small>
                <input type="checkbox" id="h2_bold_only">
            </div>
            <div class="condition-row">
                <input type="checkbox" id="h2_words_check"> <span>קצר מ-</span> 
                <input type="number" id="h2_words_val" value="6">
            </div>
        </div>

        <button class="btn btn-update" onclick="applyRules()">עדכן תצוגה מקדימה</button>
        <button class="btn btn-download" onclick="exportDoc()">הורד קובץ מעומד</button>
    </div>
</div>

<div class="main-view">
    <div class="paper-sheet" id="previewContainer">
        <p style="text-align: center; color: #95a5a6; margin-top: 50px;">העלה קובץ כדי לראות תצוגה מקדימה...</p>
    </div>
</div>

<script>
    let zipObj = null;
    let data = [];

    // בדיקת טעינת ספריות
    const timer = setInterval(() => {
        if (window.PizZip) {
            document.getElementById('lib-status').innerText = "ספריות מוכנות!";
            document.getElementById('lib-status').className = "status-ready";
            clearInterval(timer);
        }
    }, 500);

    document.getElementById('fileInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            zipObj = new PizZip(ev.target.result);
            loadContent();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    function loadContent() {
        const xml = zipObj.file("word/document.xml").asText();
        const doc = new DOMParser().parseFromString(xml, "application/xml");
        const ps = Array.from(doc.getElementsByTagNameNS("*", "p"));

        data = ps.map(p => {
            const text = Array.from(p.getElementsByTagNameNS("*", "t")).map(t => t.textContent).join("").trim();
            const isBold = p.getElementsByTagNameNS("*", "b").length > 0;
            const isCentered = p.getElementsByTagNameNS("*", "jc")[0]?.getAttribute("w:val") === "center";
            return { text, isBold, isCentered, element: p };
        }).filter(d => d.text.length > 0);

        document.getElementById('ui-controls').style.display = 'block';
        applyRules();
    }

    function checkSystem(p, nextP, prevP, prefix) {
        const isB = document.getElementById(`${prefix}_bold_check`).checked && p.isBold;
        const isC = document.getElementById(`${prefix}_center_check`).checked && p.isCentered;
        const isW = document.getElementById(`${prefix}_words_check`).checked && p.text.split(/\s+/).length <= parseInt(document.getElementById(`${prefix}_words_val`).value);
        
        const boldOnly = document.getElementById(`${prefix}_bold_only`)?.checked;
        const centerOnly = document.getElementById(`${prefix}_center_only`)?.checked;

        // אם מסומן "לבד", מספיק התנאי הספציפי
        if (boldOnly && isB) return true;
        if (centerOnly && isC) return true;

        // חוק מיוחד ל-H1: כפול
        if (prefix === 'h1' && document.getElementById('h1_double_check').checked) {
            const val = document.getElementById('h1_double_val').value;
            if (p.text.startsWith(val) && nextP?.text.startsWith(val)) return true;
        }

        // שאר התנאים בקבוצה (AND)
        let activeConds = [];
        if (document.getElementById(`${prefix}_bold_check`).checked && !boldOnly) activeConds.push(isB);
        if (document.getElementById(`${prefix}_center_check`).checked && !centerOnly) activeConds.push(isC);
        if (document.getElementById(`${prefix}_words_check`).checked) activeConds.push(isW);

        return activeConds.length > 0 && activeConds.every(v => v);
    }

    function applyRules() {
        const container = document.getElementById('previewContainer');
        container.innerHTML = '';

        data.forEach((p, i) => {
            let role = null;
            if (checkSystem(p, data[i+1], data[i-1], 'h1')) role = 'h1';
            else if (checkSystem(p, data[i+1], data[i-1], 'h2')) role = 'h2';

            p.role = role;
            const div = document.createElement('div');
            div.className = 'p-preview';
            div.innerText = p.text;
            if (role === 'h1') div.classList.add('h1-style');
            if (role === 'h2') div.classList.add('h2-style');
            if (p.isCentered) div.classList.add('center-text');
            container.appendChild(div);
        });
    }

    function exportDoc() {
        const xml = zipObj.file("word/document.xml").asText();
        const doc = new DOMParser().parseFromString(xml, "application/xml");
        const ps = Array.from(doc.getElementsByTagNameNS("*", "p"));

        let dIdx = 0;
        ps.forEach(p => {
            if (p.textContent.trim().length > 0 && data[dIdx]) {
                const role = data[dIdx].role;
                if (role) {
                    let pPr = p.getElementsByTagNameNS("*", "pPr")[0] || doc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:pPr");
                    if (!p.contains(pPr)) p.insertBefore(pPr, p.firstChild);
                    let style = pPr.getElementsByTagNameNS("*", "pStyle")[0] || doc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:pStyle");
                    if (!pPr.contains(style)) pPr.appendChild(style);
                    style.setAttribute("w:val", role === 'h1' ? "Heading1" : "Heading2");
                }
                dIdx++;
            }
        });

        zipObj.file("word/document.xml", new XMLSerializer().serializeToString(doc));
        saveAs(zipObj.generate({type:"blob"}), "מעמד_ספר_קודש.docx");
    }
</script>
</body>
</html>
