<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מעמד ספרים מקצועי - Preview</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.1/pizzip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; background: #eef2f3; }
        .sidebar { width: 350px; background: #2c3e50; color: white; padding: 20px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.2); z-index: 10; }
        .sidebar h2 { border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 1.2rem; }
        .rule-group { background: #34495e; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #456789; }
        .rule-group h3 { margin-top: 0; font-size: 1rem; color: #1abc9c; }
        .main-content { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; background: #dcdde1; }
        .preview-page { width: 100%; max-width: 800px; background: white; padding: 60px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); min-height: 100vh; border-radius: 2px; position: relative; }
        p { margin: 10px 0; line-height: 1.6; color: #333; }
        .h1-preview { font-size: 1.8em; font-weight: bold; color: #2980b9; border-right: 4px solid #2980b9; padding-right: 15px; margin: 25px 0 15px 0; background: #f0f7ff; }
        .h2-preview { font-size: 1.4em; font-weight: bold; color: #c0392b; border-right: 3px solid #c0392b; padding-right: 12px; margin: 20px 0 10px 0; background: #fff5f5; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #2c3e50; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; opacity: 0.6; pointer-events: none; }
        .btn.ready { opacity: 1; pointer-events: auto; }
        .btn-primary { background: #1abc9c; color: white; }
        .btn-download { background: #e67e22; color: white; margin-top: 20px; }
        .checkbox-row { display: flex; align-items: center; gap: 10px; margin: 8px 0; font-size: 0.9rem; cursor: pointer; }
        #status-box { padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; font-weight: bold; }
        .status-waiting { background: #f1c40f; color: #000; }
        .status-ready { background: #2ecc71; color: #fff; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>הגדרות עימוד</h2>
    
    <div id="status-box" class="status-waiting">ממתין לטעינת ספריות...</div>

    <div class="setting">
        <label>בחר קובץ וורד:</label>
        <input type="file" id="fileInput" accept=".docx" style="color: white; margin-top:5px;" disabled>
    </div>
    
    <div id="controls" style="display:none; margin-top: 20px;">
        <div class="rule-group">
            <h3>כותרת 1 (ראשית)</h3>
            <label class="checkbox-row"><input type="checkbox" id="h1_key_check" checked> מתחיל ב:</label>
            <input type="text" id="h1_key_val" value="סימן">
            <label class="checkbox-row"><input type="checkbox" id="h1_double_check"> חוק "סימן" כפול</label>
        </div>

        <div class="rule-group">
            <h3>כותרת 2 (סעיף)</h3>
            <label class="checkbox-row"><input type="checkbox" id="h2_key_check" checked> מתחיל ב:</label>
            <input type="text" id="h2_key_val" value="סעיף">
            <label class="checkbox-row"><input type="checkbox" id="h2_words_check" checked> מקסימום מילים:</label>
            <input type="number" id="h2_words_val" value="5">
            <label class="checkbox-row"><input type="checkbox" id="h2_bold_check"> רק אם מודגש</label>
        </div>

        <div class="setting">
            <label>לוגיקת שילוב (C2):</label>
            <select id="logicGate">
                <option value="OR">לפחות תנאי אחד (OR)</option>
                <option value="AND">כל התנאים יחד (AND)</option>
            </select>
        </div>

        <button class="btn btn-primary ready" onclick="updatePreview()">עדכן תצוגה</button>
        <button class="btn btn-download ready" onclick="downloadModifiedDocx()">הורד קובץ מוכן</button>
    </div>
</div>

<div class="main-content">
    <div class="preview-page" id="previewArea">
        <div style="text-align: center; color: #7f8c8d; margin-top: 100px;">
            <h3>ברוכים הבאים למעמד הכותרות</h3>
            <p>לאחר טעינת הקובץ, התוכן יופיע כאן עם סימון הכותרות שזוהו.</p>
        </div>
    </div>
</div>

<script>
    let originalZip = null;
    let paragraphsData = [];

    // בדיקה שהספריות נטענו
    const checkLibs = setInterval(() => {
        if (typeof PizZip !== 'undefined' && typeof saveAs !== 'undefined') {
            const statusBox = document.getElementById('status-box');
            statusBox.innerText = "המערכת מוכנה! העלה קובץ";
            statusBox.className = "status-ready";
            document.getElementById('fileInput').disabled = false;
            clearInterval(checkLibs);
        }
    }, 500);

    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById('status-box').innerText = "מעבד קובץ...";
        
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                originalZip = new PizZip(event.target.result);
                parseDocx(originalZip);
            } catch (err) {
                alert("שגיאה בפתיחת הקובץ. וודא שזהו קובץ .docx תקין.");
                console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    });

    function parseDocx(zip) {
        const xmlString = zip.file("word/document.xml").asText();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "application/xml");
        
        const pTags = Array.from(xmlDoc.getElementsByTagNameNS("*", "p"));

        paragraphsData = pTags.map(p => {
            const tTags = Array.from(p.getElementsByTagNameNS("*", "t"));
            const text = tTags.map(t => t.textContent).join("");
            const isBold = p.getElementsByTagNameNS("*", "b").length > 0;
            return { text: text.trim(), isBold, originalElement: p };
        }).filter(p => p.text.length > 0);

        document.getElementById('controls').style.display = 'block';
        document.getElementById('status-box').innerText = "נטענו " + paragraphsData.length + " פסקאות";
        updatePreview();
    }

    function updatePreview() {
        const area = document.getElementById('previewArea');
        area.innerHTML = '';

        const h1_key_check = document.getElementById('h1_key_check').checked;
        const h1_key_val = document.getElementById('h1_key_val').value;
        const h1_double = document.getElementById('h1_double_check').checked;
        const h2_key_check = document.getElementById('h2_key_check').checked;
        const h2_key_val = document.getElementById('h2_key_val').value;
        const h2_words_check = document.getElementById('h2_words_check').checked;
        const h2_words_val = parseInt(document.getElementById('h2_words_val').value);
        const h2_bold_check = document.getElementById('h2_bold_check').checked;
        const gate = document.getElementById('logicGate').value;

        paragraphsData.forEach((p, i) => {
            let role = null;

            if (h1_key_check && p.text.startsWith(h1_key_val)) {
                if (h1_double) {
                    const nextP = paragraphsData[i+1];
                    if (nextP && nextP.text.startsWith(h1_key_val)) role = 'h1';
                    else if (i > 0 && paragraphsData[i-1].currentRole === 'h1') role = 'h2';
                    else role = 'h2';
                } else {
                    role = 'h1';
                }
            }

            if (!role) {
                let conds = [];
                if (h2_key_check) conds.push(p.text.startsWith(h2_key_val));
                if (h2_words_check) conds.push(p.text.split(/\s+/).length <= h2_words_val);
                if (h2_bold_check) conds.push(p.isBold);

                if (conds.length > 0) {
                    const pass = (gate === "OR") ? conds.some(c => c) : conds.every(c => c);
                    if (pass) role = 'h2';
                }
            }

            p.currentRole = role;
            const div = document.createElement('div');
            div.innerText = p.text;
            div.style.padding = "5px";
            if (role === 'h1') div.className = 'h1-preview';
            else if (role === 'h2') div.className = 'h2-preview';
            else div.style.borderBottom = "1px solid #eee";
            area.appendChild(div);
        });
    }

    function downloadModifiedDocx() {
        const xmlString = originalZip.file("word/document.xml").asText();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlString, "application/xml");
        const pTags = Array.from(xmlDoc.getElementsByTagNameNS("*", "p"));

        let dataIndex = 0;
        pTags.forEach((pTag) => {
            const tTags = Array.from(pTag.getElementsByTagNameNS("*", "t"));
            const text = tTags.map(t => t.textContent).join("").trim();
            
            if (text.length > 0 && paragraphsData[dataIndex]) {
                const role = paragraphsData[dataIndex].currentRole;
                if (role) {
                    applyStyle(xmlDoc, pTag, role === 'h1' ? "Heading1" : "Heading2");
                }
                dataIndex++;
            }
        });

        const newXml = new XMLSerializer().serializeToString(xmlDoc);
        originalZip.file("word/document.xml", newXml);
        saveAs(originalZip.generate({type:"blob"}), "עימוד_סופי.docx");
    }

    function applyStyle(doc, p, styleName) {
        let pPr = p.getElementsByTagNameNS("*", "pPr")[0];
        if (!pPr) {
            pPr = doc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:pPr");
            p.insertBefore(pPr, p.firstChild);
        }
        let pStyle = pPr.getElementsByTagNameNS("*", "pStyle")[0];
        if (!pStyle) {
            pStyle = doc.createElementNS("http://schemas.openxmlformats.org/wordprocessingml/2006/main", "w:pStyle");
            pPr.appendChild(pStyle);
        }
        pStyle.setAttribute("w:val", styleName);
    }
</script>
</body>
</html>
